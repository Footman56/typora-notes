```python
# 创建临时目录保存图像（fastai 需要文件路径）
import tempfile
import os
from PIL import Image

def prepare_fastai_data(dataset):
    """将 HuggingFace 数据集转换为 fastai 可用的格式"""
    # 创建临时目录
    temp_dir = tempfile.mkdtemp()
    
    # 创建猫和狗的子目录
    cat_dir = os.path.join(temp_dir, 'cats')
    dog_dir = os.path.join(temp_dir, 'dogs')
    os.makedirs(cat_dir, exist_ok=True)
    os.makedirs(dog_dir, exist_ok=True)
    
    # 保存图像到对应目录
    for i, example in enumerate(dataset):
        image = example['image']
        label = example['labels']
        
        if label == 0:  # 猫
            filename = os.path.join(cat_dir, f'cat_{i}.jpg')
        else:  # 狗
            filename = os.path.join(dog_dir, f'dog_{i}.jpg')
        
        image.save(filename)
    
    return temp_dir, cat_dir, dog_dir

# 准备数据
temp_dir, cat_dir, dog_dir = prepare_fastai_data(ds['train'])
print(f"数据保存在: {temp_dir}")


# 您的数据加载代码
dls = DataBlock(
    blocks=(ImageBlock, CategoryBlock),
    get_items=get_image_files,
    splitter=RandomSplitter(valid_pct=0.2, seed=42),
    get_y=parent_label,
    item_tfms=[Resize(192, method='squish')]
).dataloaders(temp_dir, bs=32, device='cpu')

dls.show_batch(max_n=6)
```

报错为：RuntimeError: Could not infer dtype of numpy.uint8, fastai尝试将图像转换为张量时，可能是因为图像数据格式问题。我们可以尝试在数据加载之前先确保图像都是RGB格式，并且使用正确的转换。

```
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
Cell In[7], line 2
      1 # 您的数据加载代码
----> 2 dls = DataBlock(
      3     blocks=(ImageBlock, CategoryBlock),
      4     get_items=get_image_files,
      5     splitter=RandomSplitter(valid_pct=0.2, seed=42),
      6     get_y=parent_label,
      7     item_tfms=[Resize(192, method='squish')]
      8 ).dataloaders(temp_dir, bs=32, device='cpu')
     10 dls.show_batch(max_n=6)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/data/block.py:159, in DataBlock.dataloaders(self, source, path, verbose, **kwargs)
    157 dsets = self.datasets(source, verbose=verbose)
    158 kwargs = {**self.dls_kwargs, **kwargs, 'verbose': verbose}
--> 159 return dsets.dataloaders(path=path, after_item=self.item_tfms, after_batch=self.batch_tfms, **kwargs)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/data/core.py:333, in FilteredBase.dataloaders(self, bs, shuffle_train, shuffle, val_shuffle, n, path, dl_type, dl_kwargs, device, drop_last, val_bs, **kwargs)
    331 dl = dl_type(self.subset(0), **merge(kwargs,def_kwargs, dl_kwargs[0]))
    332 def_kwargs = {'bs':bs if val_bs is None else val_bs,'shuffle':val_shuffle,'n':None,'drop_last':False}
--> 333 dls = [dl] + [dl.new(self.subset(i), **merge(kwargs,def_kwargs,val_kwargs,dl_kwargs[i]))
    334               for i in range(1, self.n_subsets)]
    335 return self._dbunch_type(*dls, path=path, device=device)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/data/core.py:333, in <listcomp>(.0)
    331 dl = dl_type(self.subset(0), **merge(kwargs,def_kwargs, dl_kwargs[0]))
    332 def_kwargs = {'bs':bs if val_bs is None else val_bs,'shuffle':val_shuffle,'n':None,'drop_last':False}
--> 333 dls = [dl] + [dl.new(self.subset(i), **merge(kwargs,def_kwargs,val_kwargs,dl_kwargs[i]))
    334               for i in range(1, self.n_subsets)]
    335 return self._dbunch_type(*dls, path=path, device=device)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/data/core.py:104, in TfmdDL.new(self, dataset, cls, **kwargs)
    102 if not hasattr(self, '_n_inp') or not hasattr(self, '_types'):
    103     try:
--> 104         self._one_pass()
    105         res._n_inp,res._types = self._n_inp,self._types
    106     except Exception as e: 

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/data/core.py:85, in TfmdDL._one_pass(self)
     84 def _one_pass(self):
---> 85     b = self.do_batch([self.do_item(None)])
     86     if self.device is not None: b = to_device(b, self.device)
     87     its = self.after_batch(b)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/data/load.py:170, in DataLoader.do_item(self, s)
    169 def do_item(self, s):
--> 170     try: return self.after_item(self.create_item(s))
    171     except SkipItemException: return None

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:248, in Pipeline.__call__(self, o)
--> 248 def __call__(self, o): return compose_tfms(o, tfms=self.fs, split_idx=self.split_idx)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:197, in compose_tfms(x, tfms, is_enc, reverse, **kwargs)
    195 for f in tfms:
    196     if not is_enc: f = f.decode
--> 197     x = f(x, **kwargs)
    198 return x

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:114, in Transform.__call__(self, split_idx, *args, **kwargs)
--> 114 def __call__(self,*args,split_idx=None, **kwargs): return self._call('encodes', *args, split_idx=split_idx, **kwargs)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:125, in Transform._call(self, nm, split_idx, *args, **kwargs)
    123 if split_idx!=self.split_idx and self.split_idx is not None: return args[0]
    124 if not hasattr(self, nm): return args[0]
--> 125 return self._do_call(nm, *args, **kwargs)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:129, in Transform._do_call(self, nm, *args, **kwargs)
    127 def _do_call(self, nm, *args, **kwargs):
    128     if _is_tuple(x:=args[0]): 
--> 129         res = tuple(self._do_call(nm, x_, *args[1:], **kwargs) for x_ in x)
    130         return retain_type(res, x, Any)
    131     f = getattr(self,nm)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:129, in <genexpr>(.0)
    127 def _do_call(self, nm, *args, **kwargs):
    128     if _is_tuple(x:=args[0]): 
--> 129         res = tuple(self._do_call(nm, x_, *args[1:], **kwargs) for x_ in x)
    130         return retain_type(res, x, Any)
    131     f = getattr(self,nm)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fasttransform/transform.py:136, in Transform._do_call(self, nm, *args, **kwargs)
    134 try: method, ret_type = f._resolve_method_with_cache(f_args)
    135 except NotFoundLookupError: return x
--> 136 return retain_type(method(*f_args,**kwargs), x, ret_type)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/vision/core.py:246, in encodes(self, o)
    245 @ToTensor
--> 246 def encodes(self, o:PILBase): return o._tensor_cls(image2tensor(o))

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/vision/core.py:108, in image2tensor(img)
    106 def image2tensor(img):
    107     "Transform image to byte tensor in `c*h*w` dim order."
--> 108     res = tensor(img)
    109     if res.dim()==2: res = res.unsqueeze(-1)
    110     return res.permute(2,0,1)

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/torch_core.py:156, in tensor(x, *rest, **kwargs)
    148     if len(rest): x = (x,)+rest
    149     # There was a Pytorch bug in dataloader using num_workers>0. Haven't confirmed if fixed
    150     # if isinstance(x, (tuple,list)) and len(x)==0: return tensor(0)
    151     res = (x if isinstance(x, Tensor)
    152            else torch.tensor(x, **kwargs) if isinstance(x, (tuple,list,numbers.Number))
    153            else _array2tensor(x, **kwargs) if isinstance(x, ndarray)
    154            else as_tensor(x.values, **kwargs) if isinstance(x, (pd.Series, pd.DataFrame))
    155 #            else as_tensor(array(x, **kwargs)) if hasattr(x, '__array__') or is_iter(x)
--> 156            else _array2tensor(array(x), **kwargs))
    157     if res.dtype is torch.float64: return res.float()
    158     return res

File /opt/anaconda3/envs/fastai_env/lib/python3.10/site-packages/fastai/torch_core.py:139, in _array2tensor(x, requires_grad, pin_memory, **kwargs)
    136 # windows default numpy int dtype is int32, while torch tensor default int dtype is int64
    137 # https://github.com/numpy/numpy/issues/9464
    138 if sys.platform == "win32" and x.dtype==int: x = x.astype(np.int64)
--> 139 t = torch.as_tensor(x, **kwargs)
    140 t.requires_grad_(requires_grad)
    141 if pin_memory: t.pin_memory()

RuntimeError: Could not infer dtype of numpy.uint8
```

修改后代码：

```
# 创建临时目录保存图像（fastai 需要文件路径）
import tempfile
import os
from PIL import Image

def prepare_fastai_data(dataset):
    """将 HuggingFace 数据集转换为 fastai 可用的格式"""
    # 创建临时目录
    temp_dir = tempfile.mkdtemp()
    
    # 创建猫和狗的子目录
    cat_dir = os.path.join(temp_dir, 'cats')
    dog_dir = os.path.join(temp_dir, 'dogs')
    os.makedirs(cat_dir, exist_ok=True)
    os.makedirs(dog_dir, exist_ok=True)
    
    # 保存图像到对应目录
    for i, example in enumerate(dataset):
        image = example['image']
        label = example['labels']

         # 统一转换为 RGB，避免 P、RGBA、L 等模式造成 fastai 报错
        if image.mode != "RGB":
            image = image.convert("RGB")

        
        if label == 0:  # 猫
            filename = os.path.join(cat_dir, f'cat_{i}.jpg')
        else:  # 狗
            filename = os.path.join(dog_dir, f'dog_{i}.jpg')
        
        image.save(filename)
    
    return temp_dir, cat_dir, dog_dir

# 准备数据
temp_dir, cat_dir, dog_dir = prepare_fastai_data(ds['train'])
print(f"数据保存在: {temp_dir}")
```

