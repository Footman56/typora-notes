数据量比较大的表进行DELETE 操作





1. 先建立临时索引

   ```
   ALTER TABLE `kpi_draft_temp_data` 
   	ADD KEY `idx_del`(`id`,`is_del`) USING BTREE
   ;
   ```

   预计5分钟左右

2. 编写存储过程

   ```
   DROP PROCEDURE IF EXISTS batch_delete_kpi_draft_temp_data;
   
   DELIMITER $$
   
   CREATE PROCEDURE batch_delete_kpi_draft_temp_data()
   BEGIN
       DECLARE start_id INT DEFAULT 1;
       DECLARE batch_size INT DEFAULT 10000;
       DECLARE max_id INT DEFAULT 36935860;
   
       WHILE start_id <= max_id DO
           -- 每次删除指定批次大小的数据
           DELETE FROM kpi_draft_temp_data
           WHERE is_del = 1 and id > start_id AND id <= (start_id + batch_size) LIMIT batch_size;
           
           SET start_id = start_id + batch_size;
           COMMIT;                          -- 提交事务以释放锁
       END WHILE;
   END $$
   
   DELIMITER ;
   
   CALL batch_delete_kpi_draft_temp_data();
   
   DROP PROCEDURE IF EXISTS batch_delete_kpi_draft_temp_data;
   ```

   1247156ms =  1247 s = 20分

3. 删除临时索引

   ```
   ALTER TABLE `kpi_draft_temp_data` 
   	DROP KEY `idx_del`
   ;
   ```





```
// 如果有申诉记录，不能自动确认
                List<String> existAppealSet = kpiPlanAppealService.existEmpIdsByPlanAndEmpIds(currCompanyId, planId, new HashSet<>(needDoneEmpIds), PROCESS_STATUS_WAITING);
                assesseeInfoList = StreamUtil.filter(assesseeInfoList, e -> !existAppealSet.contains(e.getEmployeeId()));

```

