![](https://cdn.jsdelivr.net/gh/Footman56/imageBed2/202411052333004.png)

主从复制 是mysql 最重要的容灾机制，一个主节点，N个从节点，主节点 负责写操作，从节点负责 读操作，实现了读写分离。默认情况下复制是异步的，也可以搞成半同步



通过  `show replica status\G` 查看从库复制的情况

# 异步复制

## 基于binlog 位点同步的文件复制

```
 # 查看二进制文件
 show binary logs;
 
 # 查看指定binlog 文件的内容
 show binlog events in 'binlog.000003';
```

**主库必须开启 binlog, 从库可以不开启。**



docker 配置主从库

1. 主节点 创建挂载目录

   ```sh
    mkdir -p 
    /home/huochai/my_mysql/replication/master/data/  
    /home/huochai/my_mysql/replication/master/conf/
    /home/huochai/my_mysql/replication/master/log/  
    /home/huochai/my_mysql/replication/master/mysql-files/
   ```

2. 创建并编辑配置文件

   ```sh
   vim /my_mysql/replication/master/conf/custom.cnf
   ```

   ```sh
   [mysqld]
   ## 设置server_id，同一局域网中需要唯一
   server_id=101 
   pid-file = /var/run/mysqld/mysqld.pid
   socket = /var/run/mysqld/mysqld.sock
   datadir = /var/lib/mysql
   
   ## 指定不需要同步的数据库名称
   binlog-ignore-db=mysql  
   
   ## 开启二进制日志功能
   log-bin=mall-mysql-bin  
   
   #最大连接数
   max_connections=1000
   
   #设置默认时区
   default-time_zone='+8:00'
   
   ## 设置二进制日志使用内存大小（事务）
   binlog_cache_size=1M  
   
   innodb_buffer_pool_size = 50M
   ## 设置使用的二进制日志格式（mixed,statement,row）
   binlog_format=mixed  
   ## 二进制日志过期清理时间。默认值为0，表示不自动清理。
   expire_logs_days=7  
   
   ## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
   
   ## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
   slave_skip_errors=1062
   !includedir /etc/mysql/conf.d/
   ```
   
3. 创建主从复制的网络

   ```
   docker network create --driver bridge mysql-source-replica

4. 运行主容器

   ```
   docker run -d -p 3307:3306 \
   --privileged=true \
   --network mysql-source-replica \
   -v /home/huochai/my_mysql/replication/master/data:/var/lib/mysql  \
   -v /home/huochai/my_mysql/replication/master/conf:/etc/mysql  \
   -v /home/huochai/my_mysql/replication/master/log:/var/log/mysql \
   -v /home/huochai/my_mysql/replication/master/mysql-files:/var/lib/mysql-files \
   -e MYSQL_ROOT_PASSWORD=asdf1234  \
   -e TZ=Asia/Shanghai \
   --name mysql-master  mysql
   ```

5. 配置远程访问

   进入容器

   ```
   docker exec -it mysql-master /bin/bash
   ```

   ```
   # 登录
   mysql -u root -p
   ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'asdf1234';
   flush privileges;
   ```

6. 创建同步数据的账户

   ```
   CREATE USER 'huochai'@'%' IDENTIFIED WITH mysql_native_password BY 'asdf1234';
   
   GRANT REPLICATION SLAVE ON *.* TO 'huochai'@'%';
   
   flush privileges;	
   ```

7. 在阿里云开放端口

   

8. 创建从库，步骤同上

   ```sh
   mkdir -p  /home/huochai/my_mysql/replication/slave/data/  
   mkdir -p   /home/huochai/my_mysql/replication/slave/conf/
   mkdir -p   /home/huochai/my_mysql/replication/slave/log/  
   mkdir -p   /home/huochai/my_mysql/replication/slave/mysql-files/
   ```

   

   需要注意的是 需要将.cnf 中的server_id 修改  server_id =102

   ```
   docker run -d -p 3308:3306 \
   --privileged=true \
   -v /home/huochai/my_mysql/replication/slave/data:/var/lib/mysql  \
   -v /home/huochai/my_mysql/replication/slave/conf:/etc/mysql/conf.d  \
   -v /home/huochai/my_mysql/replication/slave/log:/var/log/mysql \
   -v /home/huochai/my_mysql/replication/slave/mysql-files:/var/lib/mysql-files \
   -e MYSQL_ROOT_PASSWORD=asdf1234  \
   -e TZ=Asia/Shanghai \
   --name mysql-slave  mysql
   ```

9. 进入容器中[需要等待一段时间]

   ```
   docker exec -it mysql-slave /bin/bash
   ```

10. 查询主容器状态，用于确定当前操作的文件，从当前文件复制的话，后续操作都可以在从库

    也可以选择别的库，别的position ，就是查找比较复杂

    ```
    mysql> mysql -uroot -p asdf1234
    mysql> show master status;
    ```

    ![image-20241105003043239](https://cdn.jsdelivr.net/gh/Footman56/imageBed2/202411050030572.png)

11. 配置主从

    ```
    change master to master_host='localhost', master_user='huochai', master_password='asdf1234', master_port=3307, master_log_file='slave-mall-mysql-bin.000020', master_log_pos=156, master_connect_retry=60;
    ```

     master_host:  主数据库的IP地址；

    master_port：主数据库的运行端口；

    master_user：在主数据库创建的用于同步数据的用户账号；

    master_password：在主数据库创建的用于同步数据的用户密码；

    master_log_file：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取File参数；

    master_log_pos：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取Position参数；

    master_connect_retry：连接失败重试的时间间隔，单位为秒

12. 开启从库查看同步状态

    ```
    mysql>start replica;
    mysql> show replica status \G;
    ```

    



##  基于全局事务标识符（GTID） 复制

首先复制是基于事务的，因为事务递增的特性会明确了顺序。主从服务器之间有一个全局事务，这个事务是区别不同服务器的。

GTID 由服务器ID 和事务id 组成，服务器ID可以 参考 server_id，是UUID

```mysql
# 查询GTID
select * from gtid_executed
```

**GTID算法需要主库和从库都开启binlog**

1. 在主库 .cnf 中新增

   ```mysql
   # 启用全局事务标识符（GTID）模式
   gtid_mode=on
   
   #强制GTID的一致性。这意味着在执行事务时，MySQL将确保所有涉及的服务器都使用相同的GTID集。
   #这个很重要，需要保证同一事务在不同服务器是一样的，才能找出真实不同的事务操作
   enforce_gtid_consistency=on
   ```

2. 从库同样配置

3. 从库设置主库

   ```mysql
   CHANGE REPLICATION SOURCE TO
   SOURCE_HOST = host,
   SOURCE_PORT = port,
   # 使用GTID
   SOURCE_AUTO_POSITION = 1
   ```

对于正在使用的服务器，想要设置GTID复制方式的话， 需要先将从库设置为只读，避免有新增的事务污染。新服务器不需要；并且设置之后需要将自读关闭

```mysql
mysql>SET @@GLOBAL.read_only = ON;
```



# 半同步复制

从5.7 之后增加的。

一定程度上保证了从库的数据是与主库一致的，但是会增加响应性能。但是也不能一直等待，需要有一个超时时间，如果超过这个时间之后，从库仍没有满足响应数量的话，就会退化成 异步复制

+ rpl_semi_sync_source_wait_for_replica_count ： 至少等待几个从库复制成功后返回
+ rpl_semi_sync_source_wait_point：这个参数控制主库执行事务的线程，是在提交事务之前（AFTER_SYNC）等待复制，还是在提交事务之后（AFTER_COMMIT）等待复制。默认是AFTER_SYNC，也就是先等待复制，再提交事务，这样就不会丢数据。



1. 安装半同步插件

   主库、从库都需要下载

   ```
   mysql>INSTALL PLUGIN rpl_semi_sync_source SONAME 'semisync_source.so';
   
   # 
   验证是否成功安装
   mysql>SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME LIKE '%semi%';
   ```

2. 开启半同步

   主库

   ```
   SET GLOBAL rpl_semi_sync_source_enabled=1;
   
   #查看是否开启
   show variables like "%semi_sync%";
   ```

   从库同