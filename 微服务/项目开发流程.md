# 零、 环境准备

1. java jdk>=1.8
2. maven
3. git 

# 一、创建数据库

```sql
DROP TABLE IF EXISTS `product`;
CREATE TABLE `product` (
  `pid` int NOT NULL AUTO_INCREMENT COMMENT '商品编号',
  `pname` varchar(50) DEFAULT NULL COMMENT '商品名称',
  `pprice` decimal(10,2) DEFAULT NULL COMMENT '商品价格',
  `ptime` varchar(50) DEFAULT NULL COMMENT '入库时间',
  `pcount` int DEFAULT NULL COMMENT '库存',
  `pstatus` int DEFAULT NULL COMMENT '商品状态',
  `modtime` int DEFAULT NULL,
  `addtime` int DEFAULT NULL COMMENT '添加时间',
  PRIMARY KEY (`pid`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商品信息表';

INSERT INTO `product` (`pid`, `pname`, `pprice`, `ptime`, `pcount`, `pstatus`, `modtime`, `addtime`) VALUES
(1, '苹果', 11.00, '2019-10-1', 11, 1, NULL, NULL),
(2, '华为', 10.00, NULL, 10, 1, NULL, NULL),
(3, '三星', 11.00, NULL, 9, 0, NULL, NULL);
```

# 二、创建maven 父子工程

## 2.1 创建顶级Maven项目

1. File->new ->project  选择maven,

<img src="/Users/peilizhi/Library/Application Support/typora-user-images/image-20220714001827564.png" alt="image-20220714001827564" style="zoom:50%;" />

2. 之后指定项目名称，包名

<img src="/Users/peilizhi/Library/Application Support/typora-user-images/image-20220714002020739.png" alt="image-20220714002020739" style="zoom:50%;" />

3. 删除src包
4. 修改pom文件

```xml
// 打包方式为pom
<packaging>pom</packaging>
//子模块
<modules>
        <module></module>
    </modules>
```

5. 使用`<dependencyManagement>`进行依赖管理，子项目使用<dependency>来指定引入需要的项目，不需要使用版本号

# 三、子工程设置为springboot项目

<img src="/Users/peilizhi/Library/Application Support/typora-user-images/image-20220714002615196.png" alt="image-20220714002615196" style="zoom:50%;" />

子工程可以引入springboot-start jar 作为基础依赖

<img src="/Users/peilizhi/Library/Application Support/typora-user-images/image-20220714002710262.png" alt="image-20220714002710262" style="zoom:50%;" />

在子项目的po m文件中指定父项目

```xml
<parent>
        <groupId>com.huochai</groupId>
        <artifactId>serviceA</artifactId>
        <version>1.0-SNAPSHOT</version>
        <!-- lookup parent from repository -->
    </parent>
```



# 四、引入依赖

需要 mysql、mybatis、mybatis-genertor（**用于生成与数据库之间的映射**）、tkmybatis（**简化sql书写**，使用封装好的工具类）、lombook、**mybatis-generator-self（用于自定义映射关系）**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <!--    声明父工程-->
    <parent>
        <artifactId>consumer</artifactId>
        <groupId>com.huochai</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>consumer-webapp</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>consumer-webapp</name>
    <description>consumer-webapp</description>

    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>

        <!-- 引入子工程-->
        <dependency>
            <groupId>com.huochai</groupId>
            <artifactId>consumer-client</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

        <!--mysql-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>

        <!--  springboot 整合 mybatis-->
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
        </dependency>

        <!--        tkmybais 用于简化sql-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!--test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>


            <!--生成代码的插件-->
            <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>${mybatis-generator.version}</version>
                <configuration>
                    <!-- 配置文件位置-->
                    <configurationFile>
                        ${basedir}/src/main/resources/generatorConfig.xml
                    </configurationFile>
                    <overwrite>true</overwrite>
                    <verbose>true</verbose>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>${mysql.version}</version>
                    </dependency>
                    <dependency>
                        <groupId>tk.mybatis</groupId>
                        <artifactId>mapper-generator</artifactId>
                        <version>${mapper-generator.version}</version>
                    </dependency>

                    <!-- 包含定义MyJavaTypeResolver-->
                    <dependency>
                        <groupId>com.huochai</groupId>
                        <artifactId>mybatis-generator-self</artifactId>
                        <version>${mybatis-generator-self.version}</version>
                        <exclusions>
                            <exclusion>
                                <groupId>org.mybatis.generator</groupId>
                                <artifactId>mybatis-generator-core</artifactId>
                            </exclusion>
                        </exclusions>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>

    </build>

</project>

```

# 五、配置数据库

mysql.properties

```properties
mysql.user=huochai
mysql.password=Asdf1234
mysql.url=jdbc:mysql://localhost:3306/mytest?useUnicode=true&zeroDateTimeBehavior=convertToNull&autoReconnect=true&characterEncoding=utf-8&useSSL=false&allowPublicKeyRetrieval=true
mysql.driver=com.mysql.cj.jdbc.Driver

# 生成PO对象位置
mybatis.poPackage=com.huochai.domain.productDomain.bean.po
mybatis.mapperPackage=mapper
# 生成Mapper方式位置
mybatis.servicePackage=com.huochai.domain.productDomain.respository.mapper
mybatis.javaProject=src/main/java
mybatis.resources=src/main/resources
```

Application.yaml

```yaml
server:
  address: 8080
spring:
  datasource:
    username: ${mysql.user}
    password: ${mysql.password}
    url: ${mysql.url}
    driver-class-name: ${mysql.driver}
```

# 六、配置项目结构

<img src="/Users/peilizhi/Library/Application Support/typora-user-images/image-20220514225817603.png" alt="image-20220514225817603" style="zoom:50%;" />



# 七、配置generatorConfig.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE generatorConfiguration  PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd" >
<generatorConfiguration>

    <!--加载外部配置项或者配置文件,   不要引入.yaml格式，mybatis解析不了
    resource 属性，从classpath开始查找
    -->
    <properties resource="mysql.properties"/>

    <!--
    classPathEntry: 引入项目需要的依赖包 -->
    <!-- <classPathEntry
             location="D:\程序\mysql-5.6.26-winx64\mysql-connector-java-5.1.17.jar" />-->
    <!--
    id:上下文id
    targetRuntime:MyBatis3Simple 不生成dao方法
    defaultModelType: flat 所有字段（主键、blob 等）全部生成在一个对象中。
    -->
    <context id="Mysql" targetRuntime="MyBatis3Simple" defaultModelType="flat">
        <!-- TKmybatis配置 -->

        <!--property用于为代码生成指定属性-->
        <property name="javaFileEncoding" value="UTF-8"/>
        <property name="beginningDelimiter" value="`"/>
        <property name="endingDelimiter" value="`"/>

        <!--        用于自己定义mapper 在自定义jar中勿动-->
        <plugin type="tk.mybatis.mapper.generator.MapperPlugin">
            <property name="mappers" value="com.huochai.tkmybatis.BaseMapper"/>
        </plugin>
        <!-- 使生成的 Model 实现 Serializable 接口  -->
        <!--        <plugin type="org.mybatis.generator.plugins.SerializablePlugin"/>-->
        <!--  为生成的 Model 覆写 toString() 方法 -->
        <!--        <plugin type="org.mybatis.generator.plugins.ToStringPlugin"/>-->
        <!--  为生成的 Model 覆写 equals() 和 hashCode() 方法 -->
        <!--        <plugin type="org.mybatis.generator.plugins.EqualsHashCodePlugin"/>-->


        <commentGenerator>
            <!-- 是否去除自动生成的注释 true：是 ： false:否 -->
            <property name="suppressAllComments" value="false"/>
            <!--  生成的注释中不包含时间信息，默认为 false -->
            <property name="suppressDate" value="true"/>

        </commentGenerator>
        <!-- 数据库链接URL、用户名、密码 -->
        <jdbcConnection driverClass="${mysql.driver}"
                        connectionURL="${mysql.url}" userId="${mysql.username}"
                        password="${mysql.password}"/>

        <!-- tinyInt转换为Integer   不会扫描当前项目,需要在别的jar中定义,再引入 -->
        <javaTypeResolver type="com.huochai.mybatis.MyJavaTypeResolver"/>

        <!-- 生成模型的包名和位置 -->
        <javaModelGenerator targetPackage="${mybatis.poPackage}" targetProject="${mybatis.javaProject}"/>
        <!-- 生成的映射文件包名和位置 -->
        <sqlMapGenerator targetPackage="${mybatis.mapperPackage}" targetProject="${mybatis.resources}"/>
        <!-- 生成service的包名和位置 -->
        <javaClientGenerator targetPackage="${mybatis.servicePackage}" targetProject="${mybatis.javaProject}"
                             type="XMLMAPPER"/>


        <!--数据库表-->
        <table tableName="product" domainObjectName="ProductPO"
               mapperName="ProductMapper">
            <generatedKey column="pid" sqlStatement="Mysql" identity="true"/>
        </table>

    </context>
</generatorConfiguration>
```

其中将TinyInt 转换成int的转换器、批量生成Mapper插件 都在 mybatis-generator-self jar 中定义

# 八、将Mapper扫描到容器中

将配置路径下的 mapper.xml 加入到mybatis 中

```yaml
mybatis:
  mapper-locations: classpath:mapper/*Mapper.xml
```

一些比较复杂的接口实现时，需要在xml中定义sql 实现，如果不加入的话会导致查询失败

如果不加入这个配置的话，就无法调用xml里面的sql,会报错：

org.apache.ibatis.binding.BindingException: Invalid bound statement (not found): com.huochai.domain.productDomain.respository.mapper.ProductMapper.queryAll





```java
import tk.mybatis.spring.annotation.MapperScan;


@SpringBootApplication
@MapperScan(basePackages = {"com.huochai.domain.**.respository.mapper"})
public class ConsumerWebappApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConsumerWebappApplication.class, args);
    }
}
```

注：使用的是tk.mybatis.spring.annotation.MapperScan这个包扫描

因为mapper中继承tkmybatis 中的通用mapper，所以需要tk.mybatis.spring.annotation.MapperScan

反之，如果mapper没有特别指定的话，就应该用import org.mybatis.spring.annotation.MapperScan; 

```java
import com.huochai.domain.productDomain.bean.po.ProductPO;
import com.huochai.tkmybatis.BaseMapper;

public interface ProductMapper extends BaseMapper<ProductPO> {
}
```





包扫描的路径不能包含 自定义的通用mapper，否则会报错：

org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'baseMapper' defined in URL [jar:file:/Users/peilizhi/apache-maven-3.6.3/repository/com/huochai/mybatis-generator-self/0.0.1-SNAPSHOT/mybatis-generator-self-0.0.1-SNAPSHOT.jar!/com/huochai/tkmybatis/BaseMapper.class]: Invocation of init method failed; nested exception is tk.mybatis.mapper.MapperException: tk.mybatis.mapper.MapperException: java.lang.ClassCastException: sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to java.lang.Class

错误原因：application.yaml 中含有mybatis.base-packages , 

```yaml
mybatis:
  base-packages: com.huochai.domain.**.respository.mapper
```







# 打包

注:作为工具类 的jar 打包的项目中不能含有application

打成maven

```xml
<build>
        <plugins>
            <plugin>
                <artifactId>maven-source-plugin</artifactId>
                <configuration>
                    <attach>true</attach>
                </configuration>
                <executions>
                    <execution>
                        <phase>compile</phase>
                        <goals>
                            <goal>jar</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                    <encoding>UTF-8</encoding>
                </configuration>
            </plugin>
        </plugins>
    </build>
```

